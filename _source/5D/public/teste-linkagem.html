<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Linkagem - 5D Dashboard</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 20px;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #ffd700, #ffeb3b);
            color: black;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .section {
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .test-result {
            background: #001122;
            border-left: 4px solid #00aaff;
            padding: 10px;
            margin: 10px 0;
        }
        .success { border-left-color: #00ff00; background: #002200; }
        .error { border-left-color: #ff0000; background: #220000; }
        .warning { border-left-color: #ffaa00; background: #221100; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #555;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background: #333;
            color: #ffd700;
        }
        pre {
            background: #111;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîó TESTE DE LINKAGEM 5D</h1>
        <p>Verifica√ß√£o da linkagem entre Planilha CSV ‚Üî Modelo 3D GLB</p>
    </div>

    <div class="section">
        <h2>üéØ Testes de Linkagem</h2>
        <button onclick="testarLinkagem()">üîç Testar Linkagem Completa</button>
        <button onclick="analisarPlanilha()">üìä Analisar Planilha CSV</button>
        <button onclick="analisarModelo3D()">üé≤ Analisar Modelo 3D</button>
        <button onclick="validarMapeamento()">‚úÖ Validar Mapeamento</button>
        <button onclick="limparLog()">üßπ Limpar Log</button>
    </div>

    <div id="resultados" class="section">
        <h2>üìã Resultados dos Testes</h2>
        <div id="log">Clique em "Testar Linkagem Completa" para come√ßar...</div>
    </div>

    <div class="section">
        <h2>üìä Dados de Debug</h2>
        <div id="debug-data">
            <p>Os dados aparecer√£o aqui ap√≥s executar os testes...</p>
        </div>
    </div>

    <script>
        function log(message, type = 'test-result') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const classes = {
                'success': 'success',
                'error': 'error',
                'warning': 'warning',
                'test-result': 'test-result'
            };
            
            logDiv.innerHTML += `<div class="test-result ${classes[type]}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function limparLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('debug-data').innerHTML = '<p>Dados limpos...</p>';
        }

        async function analisarPlanilha() {
            log('üìä === AN√ÅLISE DA PLANILHA CSV ===', 'test-result');
            
            try {
                const response = await fetch('./5d.csv');
                if (!response.ok) {
                    log('‚ùå Erro ao carregar planilha CSV', 'error');
                    return;
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                log(`üìÑ Planilha carregada: ${lines.length} linhas`, 'success');
                
                // Analisar cabe√ßalho
                const header = lines[1]; // Linha 2 tem o cabe√ßalho
                const columns = header.split(';');
                log(`üè∑Ô∏è Colunas encontradas: ${columns.length}`, 'test-result');
                log(`üìã Colunas: ${columns.map((col, i) => `${i}: "${col.trim()}"`).join(', ')}`, 'test-result');
                
                // Verificar se existe coluna Elementos3D
                const elementos3DIndex = columns.findIndex(col => col.trim().toLowerCase().includes('elementos3d') || col.trim().toLowerCase().includes('elementos 3d'));
                if (elementos3DIndex >= 0) {
                    log(`‚úÖ Coluna "Elementos3D" encontrada no √≠ndice ${elementos3DIndex}`, 'success');
                } else {
                    log('‚ùå Coluna "Elementos3D" N√ÉO encontrada!', 'error');
                }
                
                // Analisar itens com dados
                let itensComElementos3D = 0;
                let itensComDados = 0;
                const elementosExemplo = [];
                
                for (let i = 4; i < lines.length; i++) { // Pular cabe√ßalhos
                    const line = lines[i].trim();
                    if (!line || line.startsWith(';') || line.includes('____')) continue;
                    
                    const cols = line.split(';');
                    if (cols.length >= 8) {
                        itensComDados++;
                        const item = cols[0]?.trim();
                        const elementos3D = cols[8]?.trim(); // Coluna 9 (√≠ndice 8)
                        
                        if (elementos3D && elementos3D !== '') {
                            itensComElementos3D++;
                            if (elementosExemplo.length < 5) {
                                elementosExemplo.push({
                                    item: item,
                                    elementos: elementos3D
                                });
                            }
                        }
                    }
                }
                
                log(`üìä Itens com dados: ${itensComDados}`, 'test-result');
                log(`üîó Itens com Elementos3D: ${itensComElementos3D}`, itensComElementos3D > 0 ? 'success' : 'warning');
                
                if (elementosExemplo.length > 0) {
                    log('üìã Exemplos de mapeamento:', 'test-result');
                    elementosExemplo.forEach(ex => {
                        log(`   ${ex.item}: "${ex.elementos}"`, 'test-result');
                    });
                } else {
                    log('‚ö†Ô∏è Nenhum item com Elementos3D encontrado!', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erro na an√°lise: ${error}`, 'error');
            }
        }

        async function analisarModelo3D() {
            log('üé≤ === AN√ÅLISE DO MODELO 3D ===', 'test-result');
            
            // Verificar se o GLB existe
            try {
                const response = await fetch('./5d.glb');
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    log(`‚úÖ Modelo GLB encontrado (${size ? Math.round(size/1024) + 'KB' : 'tamanho desconhecido'})`, 'success');
                } else {
                    log('‚ùå Modelo GLB n√£o encontrado!', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro ao verificar GLB: ${error}`, 'error');
            }
            
            // Verificar dados do dashboard principal
            if (window.opener) {
                try {
                    const debugData = window.opener.debugData;
                    const glbElements = window.opener.glbElements;
                    
                    if (glbElements && glbElements.length > 0) {
                        log(`üéØ Elementos 3D carregados no dashboard: ${glbElements.length}`, 'success');
                        
                        // Analisar categorias
                        const categorias = {
                            fundacao: glbElements.filter(el => el.includes('3.') || el.toLowerCase().includes('fundacao')).length,
                            terreo: glbElements.filter(el => el.includes('1.') || el.includes('4.')).length,
                            superior: glbElements.filter(el => el.includes('2.') || el.includes('5.')).length,
                            outros: 0
                        };
                        categorias.outros = glbElements.length - categorias.fundacao - categorias.terreo - categorias.superior;
                        
                        log(`üèóÔ∏è Distribui√ß√£o por categoria:`, 'test-result');
                        log(`   Funda√ß√£o: ${categorias.fundacao} elementos`, 'test-result');
                        log(`   T√©rreo: ${categorias.terreo} elementos`, 'test-result');
                        log(`   Superior: ${categorias.superior} elementos`, 'test-result');
                        log(`   Outros: ${categorias.outros} elementos`, 'test-result');
                        
                        // Mostrar primeiros elementos
                        log('üìã Primeiros 10 elementos do modelo:', 'test-result');
                        glbElements.slice(0, 10).forEach((el, i) => {
                            log(`   ${i+1}. "${el}"`, 'test-result');
                        });
                        
                    } else {
                        log('‚ö†Ô∏è Nenhum elemento 3D carregado no dashboard', 'warning');
                    }
                } catch (error) {
                    log('‚ö†Ô∏è N√£o foi poss√≠vel acessar dados do dashboard principal', 'warning');
                }
            } else {
                log('‚ÑπÔ∏è Execute este teste com o dashboard principal aberto', 'test-result');
            }
        }

        async function validarMapeamento() {
            log('‚úÖ === VALIDA√á√ÉO DO MAPEAMENTO ===', 'test-result');
            
            // Verificar arquivo de mapeamento
            try {
                const response = await fetch('./mapeamento-elementos.json');
                if (response.ok) {
                    const mapeamento = await response.json();
                    log('‚úÖ Arquivo de mapeamento carregado', 'success');
                    
                    const elementos = mapeamento.mapeamento_elementos_3d;
                    const chaves = Object.keys(elementos);
                    log(`üìä ${chaves.length} itens mapeados no JSON`, 'test-result');
                    
                    // Verificar alguns exemplos
                    chaves.slice(0, 5).forEach(chave => {
                        const item = elementos[chave];
                        const qtdElementos = item.elementos ? item.elementos.length : 0;
                        log(`   ${chave}: ${item.descricao} (${qtdElementos} elementos)`, 'test-result');
                    });
                    
                } else {
                    log('‚ùå Arquivo de mapeamento n√£o encontrado', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro ao carregar mapeamento: ${error}`, 'error');
            }
        }

        async function testarLinkagem() {
            log('üîó === TESTE COMPLETO DE LINKAGEM ===', 'test-result');
            log('üîÑ Executando todos os testes...', 'test-result');
            
            await analisarPlanilha();
            await analisarModelo3D();
            await validarMapeamento();
            
            log('‚úÖ === TESTE COMPLETO FINALIZADO ===', 'success');
            log('üìä Veja os resultados acima para identificar problemas', 'test-result');
            
            // Resumo final
            log('üéØ === RESUMO PARA CORRE√á√ÉO ===', 'test-result');
            log('1. ‚úÖ A planilha CSV tem a coluna Elementos3D?', 'test-result');
            log('2. ‚úÖ Os itens t√™m valores na coluna Elementos3D?', 'test-result');
            log('3. ‚úÖ O modelo GLB foi carregado com sucesso?', 'test-result');
            log('4. ‚úÖ Os nomes dos elementos coincidem?', 'test-result');
            log('üí° Se algum item acima falhou, esse √© o problema da linkagem!', 'warning');
        }

        // Auto-executar ao carregar
        window.onload = function() {
            log('üöÄ Teste de linkagem inicializado', 'success');
            log('üí° Execute "Testar Linkagem Completa" para uma an√°lise detalhada', 'test-result');
        };
    </script>
</body>
</html>
