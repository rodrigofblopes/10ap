<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Linkagem - Teste Espec√≠fico</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 20px;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #ffd700, #ffeb3b);
            color: black;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .section {
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .result {
            background: #001122;
            border-left: 4px solid #00aaff;
            padding: 10px;
            margin: 10px 0;
        }
        .success { border-left-color: #00ff00; background: #002200; }
        .error { border-left-color: #ff0000; background: #220000; }
        .warning { border-left-color: #ffaa00; background: #221100; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        pre {
            background: #111;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 11px;
        }
        .data-table th, .data-table td {
            border: 1px solid #555;
            padding: 5px;
            text-align: left;
        }
        .data-table th {
            background: #333;
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîó DEBUG LINKAGEM ESPEC√çFICO</h1>
        <p>Teste detalhado da linkagem planilha ‚Üî modelo 3D</p>
    </div>

    <div class="section">
        <h2>üéØ Testes Espec√≠ficos</h2>
        <button onclick="testarCSV()">üìä Testar CSV</button>
        <button onclick="testarGLB()">üé≤ Testar GLB</button>
        <button onclick="testarLinkagem()">üîó Testar Linkagem</button>
        <button onclick="simularClick()">üñ±Ô∏è Simular Click Item</button>
        <button onclick="limpar()">üßπ Limpar</button>
    </div>

    <div id="resultados" class="section">
        <h2>üìã Resultados</h2>
        <div id="log">Clique em um dos testes acima...</div>
    </div>

    <div class="section">
        <h2>üìä Dados Detalhados</h2>
        <div id="dados-detalhados">
            <table class="data-table" id="tabela-csv" style="display:none;">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Descri√ß√£o</th>
                        <th>Elementos3D</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tbody-csv"></tbody>
            </table>
        </div>
    </div>

    <script>
        function log(message, type = 'result') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const classes = {
                'success': 'success',
                'error': 'error',
                'warning': 'warning',
                'result': 'result'
            };
            
            logDiv.innerHTML += `<div class="result ${classes[type]}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function limpar() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('tabela-csv').style.display = 'none';
        }

        async function testarCSV() {
            log('üìä === TESTE DETALHADO DO CSV ===', 'result');
            
            try {
                const response = await fetch('./5D.csv');
                if (!response.ok) {
                    log('‚ùå Erro ao carregar 5D.csv', 'error');
                    return;
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                log(`üìÑ CSV carregado: ${lines.length} linhas`, 'success');
                
                // Analisar cabe√ßalho
                const headerLine = lines[1]; // Linha 2
                const columns = headerLine.split(';');
                log(`üè∑Ô∏è Cabe√ßalho: ${columns.map((col, i) => `${i}:"${col.trim()}"`).join(', ')}`, 'result');
                
                // Verificar coluna Elementos3D
                const elementos3DIndex = columns.findIndex(col => 
                    col.trim().toLowerCase() === 'elementos3d' || 
                    col.trim().toLowerCase() === 'elementos 3d'
                );
                
                if (elementos3DIndex >= 0) {
                    log(`‚úÖ Coluna Elementos3D encontrada no √≠ndice ${elementos3DIndex}`, 'success');
                } else {
                    log('‚ùå Coluna Elementos3D N√ÉO encontrada!', 'error');
                    log(`üîç Colunas dispon√≠veis: ${columns.map(c => `"${c.trim()}"`).join(', ')}`, 'warning');
                }
                
                // Analisar dados
                const tbody = document.getElementById('tbody-csv');
                tbody.innerHTML = '';
                document.getElementById('tabela-csv').style.display = 'table';
                
                let itensComElementos = 0;
                
                for (let i = 4; i < lines.length; i++) { // Come√ßar da linha 5 (dados)
                    const line = lines[i].trim();
                    if (!line || line.startsWith(';') || line.includes('____')) continue;
                    
                    const cols = line.split(';');
                    if (cols.length >= 8) {
                        const item = cols[0]?.trim();
                        const descricao = cols[1]?.trim();
                        const elementos3D = cols[8]?.trim(); // Posi√ß√£o 8
                        
                        const hasElementos = elementos3D && elementos3D !== '';
                        if (hasElementos) itensComElementos++;
                        
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = item;
                        row.insertCell(1).textContent = descricao;
                        row.insertCell(2).textContent = elementos3D || '(vazio)';
                        row.insertCell(3).textContent = hasElementos ? '‚úÖ OK' : '‚ùå Vazio';
                        
                        if (hasElementos) {
                            row.style.backgroundColor = '#002200';
                        } else {
                            row.style.backgroundColor = '#220000';
                        }
                    }
                }
                
                log(`üìä Itens com Elementos3D preenchidos: ${itensComElementos}`, 
                    itensComElementos > 0 ? 'success' : 'error');
                
            } catch (error) {
                log(`‚ùå Erro: ${error}`, 'error');
            }
        }

        async function testarGLB() {
            log('üé≤ === TESTE DO MODELO GLB ===', 'result');
            
            try {
                const response = await fetch('./5d.glb');
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    log(`‚úÖ Modelo GLB acess√≠vel (${size ? Math.round(size/1024) + 'KB' : 'tamanho desconhecido'})`, 'success');
                } else {
                    log(`‚ùå Erro ${response.status}: ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro ao acessar GLB: ${error}`, 'error');
            }
        }

        async function testarLinkagem() {
            log('üîó === TESTE DE LINKAGEM ===', 'result');
            
            // Verificar se o dashboard principal est√° aberto
            if (window.opener) {
                try {
                    const itens = window.opener.debugData?.itens || [];
                    const glbElements = window.opener.glbElements || [];
                    
                    log(`üìä Itens do dashboard: ${itens.length}`, 'result');
                    log(`üé≤ Elementos GLB: ${glbElements.length}`, 'result');
                    
                    if (itens.length > 0) {
                        const itensComElementos = itens.filter(item => item.elementos3D && item.elementos3D.trim() !== '');
                        log(`üîó Itens com elementos3D: ${itensComElementos.length}`, 
                            itensComElementos.length > 0 ? 'success' : 'error');
                        
                        if (itensComElementos.length > 0) {
                            log('üìã Exemplos de linkagem:', 'result');
                            itensComElementos.slice(0, 5).forEach(item => {
                                log(`   ${item.id}: "${item.elementos3D}"`, 'result');
                            });
                        }
                    }
                    
                    if (glbElements.length > 0) {
                        log('üé≤ Primeiros elementos GLB:', 'result');
                        glbElements.slice(0, 10).forEach((el, i) => {
                            log(`   ${i+1}. "${el}"`, 'result');
                        });
                    }
                    
                } catch (error) {
                    log(`‚ùå Erro ao acessar dados do dashboard: ${error}`, 'error');
                }
            } else {
                log('‚ö†Ô∏è Dashboard principal n√£o detectado. Abra este teste a partir do dashboard principal.', 'warning');
            }
        }

        async function simularClick() {
            log('üñ±Ô∏è === SIMULA√á√ÉO DE CLICK ===', 'result');
            
            if (window.opener) {
                try {
                    // Buscar um item com elementos3D
                    const itens = window.opener.debugData?.itens || [];
                    const itemComElementos = itens.find(item => item.elementos3D && item.elementos3D.trim() !== '');
                    
                    if (itemComElementos) {
                        log(`üéØ Simulando click no item: ${itemComElementos.id} - ${itemComElementos.descricao}`, 'result');
                        log(`üîó Elementos3D: "${itemComElementos.elementos3D}"`, 'result');
                        
                        // Tentar simular o click
                        if (window.opener.handleItemSelect) {
                            window.opener.handleItemSelect(itemComElementos);
                            log('‚úÖ Click simulado com sucesso!', 'success');
                            
                            // Verificar resultado ap√≥s 1 segundo
                            setTimeout(() => {
                                const highlighted = window.opener.highlightedElements || [];
                                log(`üé® Elementos destacados ap√≥s click: ${highlighted.length}`, 
                                    highlighted.length > 0 ? 'success' : 'error');
                                
                                if (highlighted.length > 0) {
                                    log(`üü† Elementos em destaque: ${highlighted.join(', ')}`, 'success');
                                }
                            }, 1000);
                            
                        } else {
                            log('‚ùå Fun√ß√£o handleItemSelect n√£o encontrada', 'error');
                        }
                    } else {
                        log('‚ùå Nenhum item com elementos3D encontrado para testar', 'error');
                    }
                    
                } catch (error) {
                    log(`‚ùå Erro na simula√ß√£o: ${error}`, 'error');
                }
            } else {
                log('‚ö†Ô∏è Dashboard principal n√£o detectado', 'warning');
            }
        }

        // Auto-executar ao carregar
        window.onload = function() {
            log('üöÄ Debug de linkagem inicializado', 'success');
            log('üí° Execute os testes na ordem: CSV ‚Üí GLB ‚Üí Linkagem ‚Üí Simular Click', 'result');
        };
    </script>
</body>
</html>
